name: TruffleHog Secrets Scan
on: [push]
jobs:
  TruffleHog:
    runs-on: ubuntu-latest
    container:
      image: trufflesecurity/trufflehog:latest
    steps:
      - uses: actions/checkout@v3
      - name: Checkout code test
        id: mystep
        continue-on-error: true
        run: |
          mystring="${{ github.workspace }}"
          echo ${mystring:18}
          rm -rf /__w/${mystring:18}/.git
          trufflehog filesystem /__w/${mystring:18} --no-verification --no-update --fail
      - name: send msg
        if: ${{steps.mystep.outcome == 'failure'}}
        run: |
          apk --no-cache add curl
          curl --location --request POST 'https://oapi.dingtalk.com/robot/send?access_token=${{ secrets.dingding_access_token }}' \
          --header 'Content-Type: application/json' \
          --data-raw '{
              "msgtype": "markdown",
              "markdown": {
                  "title": "TruffleHog Bingo",
                  "text": "### TruffleHog Bingo â˜ž AK \n\n-----------------   \n\n **repository:** ${{ github.repository }} \n\n **message:** ${{ github.event.head_commit.message }}  \n\n **author:** ${{ github.actor }}"
              }
          }'
